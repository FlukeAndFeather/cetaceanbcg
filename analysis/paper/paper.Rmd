---
title: "Something about cetacean heart rates and ballistocardiograms"
author:
  - Max Czapanskiy:
      email: maxczap@stanford.edu
      institute: [SU]
      correspondence: true
  - More Authors:
      email: more@authors.edu
      institute: [UofA]
      correspondence: false
institute:
  - SU: Stanford University
  - UofA: University of Another Place
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  keyword 1; keyword 2; keyword 3
highlights: |
  These are the highlights. 
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->

Keywords: `r rmarkdown::metadata$keywords`

Highlights: `r rmarkdown::metadata$highlights`

<!-- The following code chunk defines some general settings how code chunks should behave. -->

```{r setup, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  fig.height = 6,
  fig.width = 6,
  dpi = 300
)
library(cetaceanbcg)
library(tidyverse)
```

<!-- The actual document text starts here: -->

# Introduction

Here is a citation [@Marwick2017]

# Background

# Methods

# Results

<!-- Here's some example analysis code: -->

```{r process-acc}
fs <- 400
fny <- fs / 2
window <- 0.25 #s
bandpass_filter <- function(x, pass) {
  signal::butter(4, pass / fny, type = "pass") %>% 
    signal::filtfilt(x)
}
jerk_filter <- function(x, size) {
  signal::sgolayfilt(x, p = 4, n = size + (size %% 2) + 1, m = 1)
}
oo_400hz <- corky_400hz %>% 
  mutate(
    # Pass-band filter acceleration
    across(surge:heave, 
           bandpass_filter, pass = c(1.0, 25.0), 
           .names = "{.col}_filt"),
    # Detect heart beats using BCG's local surge range
    surge_range = local_range(surge_filt, window * fs),
    bcg_beat = find_beats_lsr(surge_filt, window, fs),
    bcg_bpm = bpm(bcg_beat, dt),
    # Calculate jerk norm and apply smoother
    njerk = njerk(cbind(surge_filt, sway_filt, heave_filt), 
                  p = 4, n = window * fs),
    njerk_smooth = tma(njerk, window * fs)
  )
```

```{r align-ecg}
# Align ECG-detected heart beats
oo_400hz$ecg_beat <- FALSE
beat_idx <- approx(oo_400hz$dt, 
                   seq_along(oo_400hz$dt), 
                   xout = ecg_beats$dt,
                   method = "constant")$y %>% 
  na.omit()
oo_400hz$ecg_beat[beat_idx] = TRUE
oo_400hz$ecg_bpm <- with(oo_400hz, bpm(ecg_beat, dt))
```

```{r oo-sample}
ca_tz <- "Etc/GMT+7"
bcg_begin <- lubridate::ymd_hms("2021-08-16 10:09:24.5", tz = ca_tz)
bcg_end <- lubridate::ymd_hms("2021-08-16 10:09:39", tz = ca_tz)
bcg_sample <- filter(oo_400hz, between(dt, bcg_begin, bcg_end))

t <- theme_minimal() +
  theme(axis.title.x = element_blank(),
        panel.grid.minor = element_blank())
```


```{r oo-bcg-ecg, fig.cap="A: BCG, B: ECG, C: BPM comparison"}
# A: Surge + LSR
bcg_surge_lsr <- bcg_sample %>% 
  rename(Surge = surge_filt, LSR = surge_range) %>% 
  pivot_longer(c(Surge, LSR), 
               names_to = "var",
               values_to = "val")

pA <- ggplot(bcg_surge_lsr, aes(dt, val, linetype = var)) +
  geom_line(size = 0.2) +
  geom_point(data = filter(bcg_surge_lsr, bcg_beat), color = "blue") +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  scale_linetype_manual(values = c(Surge = "solid", LSR = "dashed")) +
  labs(y = bquote(Surge~(m~s^{-2}))) +
  expand_limits(x = max(bcg_sample$dt) + 1) +
  t +
  theme(legend.position = "none")

# B: ECG
ecg_sample <- corky_ecg %>% 
  filter(between(dt, first(bcg_sample$dt), last(bcg_sample$dt)))
pB <- ggplot(ecg_sample, aes(dt, ecg_uV)) +
  geom_line(size = 0.2) +
  geom_point(data = filter(ecg_sample, ecg_beat), color = "red") +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  labs(y = bquote(ECG~(mu * V))) +
  expand_limits(x = max(bcg_sample$dt) + 1) +
  t

# C: BCG + ECG
pC <- ggplot(filter(bcg_sample, bcg_beat), aes(dt, bcg_bpm)) +
  geom_line(size = 0.2) +
  geom_line(aes(y = ecg_bpm), filter(bcg_sample, ecg_beat), size = 0.2) +
  geom_point(color = "blue") +
  geom_point(aes(y = ecg_bpm), filter(bcg_sample, ecg_beat), color = "red") +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  labs(y = "Heart rate (bpm)") +
  expand_limits(x = range(bcg_sample$dt) + c(0, 1), y = c(30, 70)) +
  t

cowplot::plot_grid(pA, pB, pC,
                   align = "v", 
                   axis = "lr",
                   nrow = 3, 
                   rel_heights = c(1.5, 1.0, 0.5),
                   labels = "AUTO")
```

```{r ecg_bcg_comparison}
ecg_bpm <- filter(bcg_sample, ecg_beat)$ecg_bpm %>% tail(-1)
bcg_bpm <- filter(bcg_sample, bcg_beat)$bcg_bpm %>% head(-1)
bpm_diff <- abs((bcg_bpm - ecg_bpm) / ecg_bpm * 100)
sprintf("%0.1f%% \u00B1 %0.1f%% (mean \u00B1 sd))", mean(bpm_diff), sd(bpm_diff))
```


```{r oo-bcg-acc, fig.cap="A: The BCG signal is clearest in surge (longitudinal axis acceleration). Solid line: surge bandpass filtered to [1.0 25.0] Hz. Dashed line: local range of surge in 0.25 s sliding window (smoothed). Blue dots indicate peak of the BCG I-wave. B: BCG signal is not as strong in heave (dorso-ventral axis) or sway (lateral axis) as in surge. The sway signal is likely due to movement of the chest cavity (see video S1). C: Some, but not all, heart beats are visible as peaks in the norm of the jerk vector."}
# A: Surge
pA <- ggplot(bcg_sample, aes(dt, surge_filt)) +
  geom_line(size = 0.2) +
  geom_point(data = filter(bcg_sample, bcg_beat), color = "blue") +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  labs(y = bquote(Surge~(m~s^{-2}))) +
  expand_limits(x = max(bcg_sample$dt) + 1) +
  t

# B: Sway, heave
bcg_sway_heave <- bcg_sample %>% 
  rename(Sway = sway_filt, Heave = heave_filt) %>% 
  pivot_longer(c(Sway, Heave), 
               names_to = "axis",
               values_to = "acceleration")
pB <- ggplot(bcg_sway_heave, aes(dt, acceleration)) +
  geom_point(data = filter(bcg_sway_heave, bcg_beat), color = "blue") +
  geom_line(size = 0.2) +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  facet_grid(axis ~ .) +
  labs(y = bquote(Acc~(m~s^{-2}))) +
  t

# C: Jerk
pC <- ggplot(bcg_sample, aes(dt, njerk_smooth)) +
  geom_line(size = 0.2) +
  geom_point(data = filter(bcg_sample, bcg_beat), color = "blue") +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  labs(y = bquote(Jerk~(m~s^{-3}))) +
  t

cowplot::plot_grid(pA, pB, pC,
                   align = "v", 
                   axis = "lr",
                   nrow = 3, 
                   labels = "AUTO")
```

```{r bw-beats}
window = 1.8 # s
bw_elg <- bw180905_53_elg

# Apply filters as with killer whale data, but narrower band
bw_400hz <- bw180905_53_400hz %>% 
  mutate(
    # Pass-band filter acceleration
    across(surge:heave, 
           bandpass_filter, pass = c(1.0, 10.0), 
           .names = "{.col}_filt"),
    # Calculate jerk norm and apply smoother
    njerk = njerk(cbind(surge_filt, sway_filt, heave_filt), 
                  p = 4, n = window * fs),
    njerk_smooth = tma(njerk, window * fs),
    # Annotate regions
    rid_left = approx(bw_elg$start, bw_elg$region_id, dt, "constant")$y,
    rid_right = approx(bw_elg$stop, bw_elg$region_id, dt, "constant", yleft = 0)$y + 1,
    region_id = ifelse(rid_left == rid_right, rid_left, NA),
    # Find heart beats using jerk cue
    surge_range = local_range(surge_filt, window * fs),
    bcg_beat = find_beats_jerk(njerk_smooth, !is.na(region_id), window, fs)
  ) %>% 
  # Calculate heart rate within each region
  group_by(region_id) %>% 
  mutate(bcg_bpm = bpm(bcg_beat, dt)) %>% 
  ungroup() %>% 
  select(-c(rid_left, rid_right))
```

```{r bw-bcg}
bw_bcg_plot <- function(rid) {
  ca_tz <- "Etc/GMT+7"
  bcg_sample <- filter(bw_400hz, region_id == rid)
  
  # A: Surge + LSR
  bcg_surge_lsr <- bcg_sample %>% 
    rename(Surge = surge_filt, LSR = surge_range) %>% 
    pivot_longer(c(Surge, LSR), 
                 names_to = "var",
                 values_to = "val")
  
  pA <- ggplot(bcg_surge_lsr, aes(dt, val, linetype = var)) +
    geom_line(size = 0.2) +
    geom_point(data = filter(bcg_surge_lsr, bcg_beat), color = "blue") +
    scale_x_datetime(date_labels = "%H:%M:%S") +
    scale_linetype_manual(values = c(Surge = "solid", LSR = "dashed")) +
    labs(y = bquote(Surge~(m~s^{-2}))) +
    t +
    theme(legend.position = "none")
  
  # B: BPM
  pB <- ggplot(filter(bcg_sample, bcg_beat), aes(dt, bcg_bpm)) +
    geom_line() +
    geom_point(color = "blue") +
    scale_x_datetime(date_labels = "%H:%M:%S") +
    labs(y = "Heart rate (bpm)") +
    expand_limits(x = range(bcg_sample$dt), y = 0) +
    t
  
  # C: Sway, heave
  bcg_sway_heave <- bcg_sample %>% 
    rename(Sway = sway_filt, Heave = heave_filt) %>% 
    pivot_longer(c(Sway, Heave), 
                 names_to = "axis",
                 values_to = "acceleration")
  
  pC <- ggplot(bcg_sway_heave, aes(dt, acceleration)) +
    geom_line(size = 0.2) +
    geom_point(data = filter(bcg_sway_heave, bcg_beat), color = "blue") +
    scale_x_datetime(date_labels = "%H:%M:%S") +
    facet_grid(axis ~ .) +
    labs(y = bquote(Acc~(m~s^{-2}))) +
    t
  
  # D: Jerk
  pD <- ggplot(bcg_sample, aes(dt, njerk_smooth)) +
    geom_line(size = 0.2) +
    geom_point(data = filter(bcg_sample, bcg_beat), color = "blue") +
    scale_x_datetime(date_labels = "%H:%M:%S") +
    labs(y = bquote(Jerk~(m~s^{-3}))) +
    expand_limits(y = 0) +
    t

  p <- cowplot::plot_grid(pA, pB, pC, pD,
                          align = "v", 
                          axis = "lr",
                          nrow = 4, 
                          rel_heights = c(1.5, 0.75, 1, 1),
                          labels = "AUTO")
  
  ggsave(here::here(sprintf("analysis/figures/bw_bcg/bw_bcg_%02i.png", rid)), p)
}

# foo <- lapply(unique(na.omit(bw_400hz$region_id)), bw_bcg_plot)
```

```{r bradycardia-relax, fig.cap="Heartrates observed in the ballistocardiogram exhibit characteristic diving physiology patterns. Bradycardia is greatest at the start of the dive (~4-5 bpm), increasing towards the end (~8-9 bpm)."}
bw10hz <- bw180905_53_10hz %>%
  mutate(
    dive_id = split_dives(dt, depth,
                          surface = 2, min_depth = 10, min_dur = 5 * 60),
    dive_norm = normalize_dives(dive_id)
  )
bw_400hz$dive_norm <- approx(bw10hz$dt, bw10hz$dive_norm, bw_400hz$dt)$y

bpm_data <- bw_400hz %>%
  drop_na(bcg_bpm)

bpm_ts <- RobustLinearReg::theil_sen_regression(bcg_bpm ~ dive_norm, bpm_data)

bpm_pred <- tibble(dive_norm = seq(0, 1, length.out = 100)) %>%
  mutate(bcg_bpm = predict(bpm_ts, newdata = .))

ggplot(bpm_data, aes(dive_norm, bcg_bpm)) +
  geom_point() +
  geom_line(data = bpm_pred, color = "blue", size = 1.5) +
  scale_x_continuous(labels = scales::percent) +
  labs(x = "Dive time (normalized)",
       y = "Heartrate (bpm)") +
  expand_limits(y = 0) +
  theme_classic()
```

The magnitude of bradycardia was strongest at the start of dives and relaxed towards the end. On average, heartrate increased from `r round(predict(bpm_ts, data.frame(dive_norm = 0)), 1)` bpm at the start of dives to `r round(predict(bpm_ts, data.frame(dive_norm = 1)), 1)` bpm by the end (Theil-Sen regression, $p < 10^{-10}$).

```{r jerk-peaks, fig.cap="Major peak selection procedure for identifying heartbeats. A Even after smoothing, the norm of the jerk vector (line) has peaks that correspond to heartbeats (solid points) and artifacts (hollow points). We used a data-driven approach to retaining only major peaks. 75 s data excerpt shown as example. B In height-prominence space, peaks form two clusters corresponding to valid heartbeats (solid) and artifacts (hollow). C To separate the clusters, we calculated each peak's distance from the greatest peak (triangle); retaining all peaks closer to the greatest peak (solid circles) than the valley in the bimodal distance distribution (red dashed line) and rejecting the farther peaks (hollow circles). D The bi-modal distribution of peak distances. We selected the the valley in the distance density (blue line) for the distance threshold (red dashed line). Solid and hollow histogram bars correspond to retained and rejected peaks, respectively."}
# Visualize peak thresholding algorithm
jerk <- bw_400hz$njerk_smooth
jerk[is.na(bw_400hz$region_id)] <- 0
window_s <- 1.8
fs_hz <- 400

# Find peaks
peaks <- pracma::findpeaks(jerk, minpeakdistance = window * fs_hz)
jerk_peaks <- slice(bw_400hz, peaks[, 2]) %>% 
  mutate(
    height = peaks[, 1],
    prominence = peak_prominences(jerk, peaks[, 2]),
    distance = sqrt((max(height) - height)^2 + (max(prominence) - prominence)^2)
  ) %>% 
  arrange(dt)
dist_density <- density(jerk_peaks$distance)
dist_peaks <- pracma::findpeaks(dist_density$y)
interpeaks <- dist_peaks[1, 2]:dist_peaks[2, 2]
dist_valley <- pracma::findpeaks(-dist_density$y[interpeaks])
dist_thr <- dist_density$x[dist_valley[1, 2] + dist_peaks[1, 2] - 1]
jerk_peaks <- jerk_peaks %>%  
  mutate(distance_cat = cut(distance, 
                            c(-Inf, 
                              min(distance[distance > 0]) / 2, 
                              dist_thr, 
                              Inf),
                            labels = c("max",
                                       "keep",
                                       "reject")))
shape_scale <- scale_shape_manual(values = c(max = 6, keep = 16, reject = 1))
hp_labs <- labs(x = "Peak height", y = "Peak prominence")

# Using region 14 as an example
jerk_example <- filter(bw_400hz, region_id == 14)
peak_example <- jerk_peaks %>% 
  filter(between(dt, first(jerk_example$dt), last(jerk_example$dt))) %>% 
  mutate(i = row_number())

# Labeled peaks in jerk
pA <- ggplot(jerk_example, aes(dt, njerk_smooth)) +
  geom_line() +
  geom_point(aes(shape = distance_cat), peak_example) +
  ggrepel::geom_text_repel(aes(label = i), peak_example) +
  shape_scale +
  expand_limits(y = 0) +
  labs(y = bquote(Jerk~(m~s^{-3}))) +
  theme_classic() +
  theme(axis.title.x = element_blank(),
        legend.position = "none")
# Peak height, prominence
pB <- ggplot(peak_example, aes(height, prominence, shape = distance_cat)) +
  geom_point() +
  ggrepel::geom_text_repel(aes(label = i), max.overlaps = Inf) +
  shape_scale +
  hp_labs +
  coord_fixed() +
  theme_classic() +
  theme(legend.position = "none")

# All heights, prominences (with threshold)
x0 <- max(jerk_peaks$height)
y0 <- max(jerk_peaks$prominence)
r <- dist_thr
theta <- seq(0, 2 * pi, length.out = 256)
threshold <- tibble(
  height = x0 + r * cos(theta),
  prominence = y0 + r * sin(theta)
) %>% 
  filter(height <= x0,
         prominence <= y0)

pC <- jerk_peaks %>% 
    mutate() %>% 
  ggplot(aes(height, prominence)) +
  geom_point(aes(shape = distance_cat, size = distance_cat)) +
  annotate("path", 
           x = threshold$height, y = threshold$prominence,
           color = "red", linetype = "dashed") +
  shape_scale +
  scale_size_manual(values = c(max = 3, keep = 1, reject = 1)) +
  hp_labs +
  coord_fixed() +
  theme_classic() +
  theme(legend.position = "none")

pD <- ggplot(jerk_peaks, aes(distance)) +
  geom_histogram(aes(y = ..density.., fill = distance < dist_thr), 
                 bins = 25, color = "black") +
  geom_density(color = "blue") +
  geom_vline(xintercept = dist_thr, color = "red", linetype = 2) +
  scale_fill_manual(values = c(`TRUE` = "black", `FALSE` = "white")) +
  labs(x = "Distance from max") +
  theme_classic() +
  theme(legend.position = "none")

cowplot::plot_grid(pA, pB, pC, pD,
                   align = "h",
                   axis = "bt",
                   nrow = 2,
                   labels = "AUTO")
```

Figure \@ref(fig:oo-bcg-ecg) shows how we can have a caption and cross-reference for a plot.

# Discussion

# Conclusion

# Acknowledgements

<!-- The following line inserts a page break  -->

\newpage

# References 

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

<div id="refs"></div>

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```

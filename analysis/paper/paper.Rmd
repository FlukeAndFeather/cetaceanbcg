---
title: "Accelerometer-derived ballistocardiogram confirms blue whale (*Balaenoptera musculus*) heart rate during diving bradycardia"
author:
  - Max Czapanskiy:
      email: maxczap@stanford.edu
      institute: [SU]
      correspondence: true
  - More Authors:
      email: more@authors.edu
      institute: [UofA]
      correspondence: false
institute:
  - SU: Stanford University
  - UofA: University of Another Place
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Comparative physiologists have long been interested in heart rate, especially in breath-holding divers like marine mammals. To date, an electrocardiogram has only been recorded for a single large cetacean individual, but hundreds of accelerometer tags have been deployed on diverse large cetacean species. Here we demonstrate a ballistocardiogram method that detects resting apneic heart rate using only high-resolution accelerometer data. We validated the method on a killer whale (*Orcinus orca*) simultaneously tagged with accelerometer and ECG. We applied the method to accelerometer data from a blue whale (*Balaenoptera musculus*) and confirmed previously observed cardiovascular patterns, including the degree of diving bradycardia in this species (4-8 bpm) and progressive bradycardia relaxation during dives. Our ballistocardiogram method may be applied to mine heart rates from previously collected accelerometery and greatly expand our understanding of comparative cardiovascular physiology.
keywords: |
  ballistocardiogram; diving physiology; cardiovascular physiology; accelerometer; bio-logging; marine mammal
---

Keywords: `r rmarkdown::metadata$keywords`

```{r setup, echo=FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  fig.height = 8,
  fig.width = 8,
  dpi = 300
)
library(cetaceanbcg)
library(tidyverse)
```

# Introduction

Here is a citation [@Marwick2017]

# Materials and methods

## Animal tagging

* A captive killer whale (*Orcinus orca*) was double-tagged with a CATS unit and ECG recorder.
* The CATS unit was placed behind the left pectoral flipper and the ECG recorder on the ventral center line. 
* Trainers instructed the whale to hold a submerged position.
* A blue whale (*Balaenoptera musculus*) was tagged with a CATS unit.
* The tag slid behind the right pectoral flipper, where it remained overnight.
* While tagged, the blue whale engaged in apparent resting behavior. We manually labeled motionless periods. Specifically, we looked for regions with low amplitude y-axis gyroscope signal, since fluke-strokes are readily apparent in this signal (Gough et al. 2019).
* CATS tags programmed to collect 400 Hz accelerometer, 50 Hz magnetometer, 50 Hz gyroscope, and 10 Hz pressure. Data processed using CATS Toolbox (Cade et al. 2021 Animal Biotelemetry)
* Relevant permits (IACUC, NMFS, ???)

## Signal processing

The BCG waveform is three dimensional, but strongest in the longitudinal axis (Inan et al. 2014 IEEE JBHI). We tested 1d and 3d metrics for identifying heartbeats in acceleration data based on the methods of Lee et al. (2016 Sensors).

For windowed operations, we used 0.5 s for killer whale data and 2.0 s for blue whale data.

**Procedure**

1. Remove noise and de-trend acceleration with a 5th order Butterworth band-pass filter (killer whale: [1-25Hz], blue whale: [1-10Hz]) (cite `signal`).
2. Enhance peaks by differentiating acceleration using a 4th order Savitzky-Golay filter (cite `signal`).
3. Make all peaks positive and further enhance peaks by calculating the Shannon entropy. $H_i=-\sum_{k} |a_{ik}| \times ln(|a_{ik}|)$ where $k$ is the acceleration axis. In the 1d case, $k$ is surge only.
4. Remove noise by applying a triangular moving average smoother.
5. Extract peaks and heuristically remove minor peaks (see supplemental). 

This procedure can be applied to either 1d (i.e., surge-only) or 3d acceleration. In the case of 3d acceleration, the band-pass and Savitzky-Golay filters are applied to each axis independently.

## ECG validation on killer whale

We calculated the percent error in paired BCG- and ECG-derived instantaneous heart rates (1d BCG only). 

## BCG application to blue whale

We tested whether the 3d BCG was more robust than 1d BCG in field data by comparing the signal-to-noise ratios. For both BCGs, we calculated the power spectral density (cite package `psd`). Blue whale apneic heart rate (in the absence of high effort activities such as feeding) is 4-8 bpm (Goldbogen et al. 2019 PNAS), so we quantified "signal" as the integration of the power spectral density curve from 4-8 bpm and "noise" as the integrated remainder, up to 60 bpm.

We also tested whether BCG-derived instantaneous heart rates exhibited bradycardia relaxation over the course of dives, consistent with diving physiology patterns in marine mammals (Goldbogen et al. 2019 PNAS, McDonald and Ponganis, 2014). We assigned dive start and end times when the whale swam deeper than 2 m, retaining dives that exceeded 10 m depth and 5 minutes duration. Dive times were normalized from 0 (start of dive) to 1 (end of dive). We regressed instantaneous heart rate against normalized dive time using robust Theil-Sen regression (cite package `RobustLinearReg`; Sen, 1968; and Theil, 1950) due to heteroscedascity and tested whether the slope was greater than 0.  

## Reproducibility

The data and code used in this analysis were packaged as a research compendium using `rrtools` (Marwick et al., 2018; cite `rrtools`).

# Results and discussion

## ECG validation on killer whale

```{r process-acc}
ca_tz <- "Etc/GMT+7"
bcg_begin <- lubridate::ymd_hms("2021-08-16 10:09:24.5", tz = ca_tz)
bcg_end <- lubridate::ymd_hms("2021-08-16 10:09:38", tz = ca_tz)
oo_400hz <- corky_400hz %>% 
  filter(between(dt, bcg_begin - 10, bcg_end + 10)) %>% 
  mutate(surge_filt = filter_acc(surge, 400, 25.0),
         surge_diff = lead(surge_filt) - surge_filt,
         surge_se = shannon_entropy(surge_diff),
         surge_smooth = tma(surge_se, 0.5 * 400)) %>% 
  filter(between(dt, bcg_begin, bcg_end)) %>% 
  mutate(bcg_beat = find_beats(surge_smooth, 400, 0.5),
         bcg_bpm = bpm(bcg_beat, dt))
```

```{r align-ecg}
# Align ECG-detected heart beats
oo_400hz$ecg_beat <- FALSE
beat_idx <- approx(oo_400hz$dt, 
                   seq_along(oo_400hz$dt), 
                   xout = ecg_beats$dt,
                   method = "constant")$y %>% 
  na.omit()
oo_400hz$ecg_beat[beat_idx] = TRUE
oo_400hz$ecg_bpm <- with(oo_400hz, bpm(ecg_beat, dt))
```

```{r ecg_bcg_comparison}
bcg_bpm <- filter(oo_400hz, bcg_beat) %>% 
  select(dt, bcg_bpm)
nearest_bcg <- function(t) {
  bcg_bpm$bcg_bpm[which.min(abs(t - bcg_bpm$dt))]
}
ecg_bpm <- filter(oo_400hz, ecg_beat) %>% 
  mutate(bcg_bpm = map_dbl(dt, nearest_bcg),
         bpm_diff = abs(bcg_bpm - ecg_bpm) / ecg_bpm) %>% 
  drop_na(bpm_diff)

mean_bpm_diff <- mean(ecg_bpm$bpm_diff)
sd_bpm_diff <- sd(ecg_bpm$bpm_diff)
```

The ECG and BCG yielded nearly identical heart rate estimations (Fig. \@ref(fig:oo-bcg-ecg)). We collected 14 s of simultaneous ECG and BCG data during a motionless, submerged breath hold. BCG-derived instantaneous heart rates were within `r sprintf("%0.1f%% \u00B1 %0.1f%%", mean_bpm_diff * 100, sd_bpm_diff * 100)` of the ECG-derived rates (mean \u00B1 standard deviation).

## BCG application to blue whale

```{r motionless}
bw_elg <- bw180905_53_elg %>% 
  mutate(depth_min = map2_dbl(start, stop, function(t1, t2) {
    bw180905_53_10hz %>% 
      filter(between(dt, t1, t2)) %>% 
      pull(depth) %>% 
      min()
  }),
  depth_max = map2_dbl(start, stop, function(t1, t2) {
    bw180905_53_10hz %>% 
      filter(between(dt, t1, t2)) %>% 
      pull(depth) %>% 
      max()
  })
  )
n_motionless <- nrow(bw_elg)
motionless_minutes <- as.numeric(sum(bw_elg$stop - bw_elg$start), unit = "mins")
```

We generated 1d and 3d BCGs for 2 hours of data, including 10 rest dives and `r n_motionless` motionless periods totaling `r format(motionless_minutes, digits = 3)` minutes (Fig. \@ref(fig:bw-profile)).

```{r bw-beats}
bw_400hz <- bw180905_53_400hz %>%
  mutate(
    across(surge:heave, 
           filter_acc, fs = 400, upper = 10.0, 
           .names = "{.col}_filt"),
    surge_diff = lead(surge_filt) - surge_filt,
    surge_se = shannon_entropy(surge_diff),
    surge_smooth = tma(surge_se, 0.5 * 400),
    jerk = jerk(cbind(surge_filt, sway_filt, heave_filt), 
                fs = 400, p = 4, n = 2 * 400 + 1),
    jerk_se = shannon_entropy(jerk),
    jerk_smooth = tma(jerk_se, 2 * 400),
    # Annotate regions
    rid_left = approx(bw_elg$start, 
                      bw_elg$region_id, 
                      dt, 
                      "constant")$y,
    rid_right = approx(bw_elg$stop, 
                       bw_elg$region_id, 
                       dt, 
                       "constant", 
                       yleft = 0)$y + 1,
    region_id = ifelse(rid_left == rid_right, rid_left, NA),
    # Zero-out signal in non-valid regions (i.e. remove movement artifacts)
    jerk_smooth = ifelse(is.na(region_id), 0, jerk_smooth),
    bcg_beat = find_beats(jerk_smooth, 400, 2)
  ) %>% 
  # Calculate heart rate within each region
  group_by(region_id) %>% 
  mutate(bcg_bpm = bpm(bcg_beat, dt)) %>% 
  ungroup() %>% 
  select(-c(rid_left, rid_right))
```

```{r save-bw-bcg, eval=FALSE}
walk(unique(na.omit(bw_400hz$region_id)), function(rid) {
  p <- bw_bcg_plot(rid)
  ggsave(here::here(sprintf("analysis/figures/bw_bcg/bw_bcg_%02i.png", rid)), p)
})
```

The triaxial BCG (Fig. \@ref(fig:bw-bcg)) produced clearer signal than the surge-only BCG. The signal-to-noise ratio was 2.00 for the triaxial BCG, compared to 0.17 for the surge-only BCG (Fig. \@ref(fig:psd-plot)).

```{r bw-psd}
bcg1d_psd <- with(bw_400hz, pspectrum(surge_smooth[!is.na(region_id)], 400))
bcg3d_psd <- with(bw_400hz, pspectrum(jerk_smooth[!is.na(region_id)], 400))

bw_psd <- tibble(
  metric = "Surge only",
  freq_hz = bcg1d_psd$freq,
  spec = bcg1d_psd$spec
) %>% 
  rbind(
    tibble(
      metric = "Triaxial",
      freq_hz = bcg3d_psd$freq,
      spec = bcg3d_psd$spec
    )
  ) %>% 
  mutate(freq_bpm = freq_hz * 60) %>% 
  filter(freq_bpm <= 60)

psd_s2n <- bw_psd %>% 
  group_by(metric) %>% 
  summarize(signal = pracma::trapz(freq_bpm[freq_bpm >= 4 & freq_bpm <= 8],
                                   spec[freq_bpm >= 4 & freq_bpm <= 8]),
            noise = pracma::trapz(freq_bpm, spec) - signal) %>% 
  mutate(s2n = signal / noise)
```

```{r brady-relax}
bw10hz <- bw180905_53_10hz %>%
  mutate(
    dive_id = split_dives(dt, depth,
                          surface = 2, min_depth = 10, min_dur = 5 * 60),
    dive_norm = normalize_dives(dive_id)
  )
bw_400hz$dive_norm <- approx(bw10hz$dt, bw10hz$dive_norm, bw_400hz$dt)$y

bpm_data <- bw_400hz %>%
  drop_na(bcg_bpm)

bpm_ts <- RobustLinearReg::theil_sen_regression(bcg_bpm ~ dive_norm, bpm_data)

bpm_pred <- tibble(dive_norm = seq(0, 1, length.out = 100)) %>%
  mutate(bcg_bpm = predict(bpm_ts, newdata = .))
```

3d BCG-derived heart rates exhibited a relaxation of bradycardia over the course of dives. Average heart rate increased from `r format(bpm_pred$bcg_bpm[1], digits = 2)` bpm at the start of dives to `r format(bpm_pred$bcg_bpm[nrow(bpm_pred)], digits = 2)` at the end of dives (Theil-Sen regression, $p < 10^{-10}$) (Fig \@ref(bradycardia-relax)).

# Acknowledgements

* Everyone who helped collect and process the blue whale data
* The Sea World trainers

\newpage

# Figures

```{r oo-bcg-ecg, fig.cap="The ECG (A) and BCG (E) produced nearly identical heart beat predictions (red and blue points, respectively). B-D display the intermediate steps in the BCG signal processing procedure. B: surge after filtering, C: after differencing, D: Shannon entropy. Y-axis labeling follows Lee et al. (2016 Sensors) and y-axis values were excluded because the filtering process introduces magnitude distortion; only the relative shape of the signal is relevant to the analysis."}
t <- theme_classic() +
  theme(axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank())

# A: ECG
ecg_sample <- corky_ecg %>% 
  filter(between(dt, first(oo_400hz$dt), last(oo_400hz$dt)))
pA <- ggplot(ecg_sample, aes(dt, ecg_uV)) +
  geom_line(size = 0.2) +
  geom_point(data = filter(ecg_sample, ecg_beat), color = "red") +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  labs(y = bquote(ECG~(mu * V))) +
  expand_limits(x = max(oo_400hz$dt) + 1) +
  t

# B: Filtered surge
pB <- ggplot(oo_400hz, aes(dt, surge_filt)) +
  geom_line(size = 0.2) +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  labs(y = bquote(f[HR])) +
  t +
  theme(axis.text.y = element_blank())

# C: Surge diff
pC <- ggplot(oo_400hz, aes(dt, surge_diff)) +
  geom_line(size = 0.2) +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  labs(y = "dBCG") +
  t +
  theme(axis.text.y = element_blank())

# D: Shannon entropy
pD <- ggplot(oo_400hz, aes(dt, surge_se)) +
  geom_line(size = 0.2) +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  labs(y = "seBCG") +
  t +
  theme(axis.text.y = element_blank())

# E: Smoothed
pE <- ggplot(oo_400hz, aes(dt, surge_smooth)) +
  geom_line(size = 0.2) +
  geom_point(data = filter(oo_400hz, bcg_beat), color = "blue") +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  labs(y = "Y") +
  t +
  theme(axis.text.y = element_blank())

cowplot::plot_grid(pA, pB, pC, pD, pE,
                   align = "v", 
                   axis = "lr",
                   ncol = 1, 
                   labels = "AUTO")
```

```{r bw-profile, fig.cap="Blue whale dive profile. Motionless periods indicated by pink boxes."}
ggplot(bw180905_53_10hz, aes(dt, depth)) +
  geom_line(size = 0.5) +
  geom_rect(aes(xmin = start, xmax = stop, ymin = depth_min, ymax = depth_max),
            bw_elg,
            inherit.aes = FALSE,
            fill = "orchid1",
            color = NA,
            alpha = 0.5) +
  scale_x_datetime(date_labels = "%H:%M:%S") +
  scale_y_reverse("Depth (m)") +
  theme_classic() +
  theme(axis.title.x = element_blank())
```

```{r bw-bcg, fig.cap="Example of signal processing for 3d BCG. A: filtered triaxial acceleration, B: after differencing, C: Shannon entropy, D: after smoothing. Identified heart beats in blue. Y-axis labeling follows Lee et al. (2016 Sensors) and y-axis values were excluded because the filtering process introduces magnitude distortion; only the relative shape of the signal is relevant to the analysis."}
bw_bcg_plot <- function(rid) {
  bcg_sample <- filter(bw_400hz, region_id == rid)
  
  t <- theme_classic() +
  theme(axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank())

  # A: Filtered surge
  pA <- bcg_sample %>% 
    rename(Surge = surge_filt, Sway = sway_filt, Heave = heave_filt) %>% 
    pivot_longer(Surge:Heave, names_to = "axis", values_to = "acc") %>% 
    mutate(axis = factor(axis, levels = c("Surge", "Sway", "Heave"))) %>% 
    ggplot(aes(dt, acc)) +
    geom_line(size = 0.2) +
    scale_x_datetime(date_labels = "%H:%M:%S") +
    scale_y_continuous(n.breaks = 3) +
    facet_grid(rows = vars(axis)) +
    labs(y = bquote(f[HR])) +
    t +
    theme(axis.text.y = element_blank())
  
  # B: Jerk vectors
  pB <- bcg_sample %>% 
    mutate(jerk = set_names(as_tibble(jerk), c("Surge", "Sway", "Heave"))) %>% 
    unpack(jerk) %>% 
    pivot_longer(Surge:Heave, names_to = "axis", values_to = "jerk") %>% 
    mutate(axis = factor(axis, levels = c("Surge", "Sway", "Heave"))) %>% 
    ggplot(aes(dt, jerk)) +
    geom_line(size = 0.2) +
    scale_x_datetime(date_labels = "%H:%M:%S") +
    scale_y_continuous(n.breaks = 3) +
    facet_grid(rows = vars(axis)) +
    labs(y = "dBCG") +
    t +
    theme(axis.text.y = element_blank())
  
  # C: Shannon entropy of jerk (NOT jerk norm)
  pC <- ggplot(bcg_sample, aes(dt, jerk_se)) +
    geom_line(size = 0.2) +
    scale_x_datetime(date_labels = "%H:%M:%S") +
    labs(y = "seBCG") +
    t +
    theme(axis.text.y = element_blank())
  
  # D: Smoothed
  pD <- ggplot(bcg_sample, aes(dt, jerk_smooth)) +
    geom_line(size = 0.2) +
    geom_point(data = filter(bcg_sample, bcg_beat), color = "blue") +
    scale_x_datetime(date_labels = "%H:%M:%S") +
    labs(y = "Y") +
    t +
    theme(axis.text.y = element_blank())
  
  cowplot::plot_grid(pA, pB, pC, pD,
                     align = "v", 
                     axis = "lr",
                     ncol = 1, 
                     labels = "AUTO")
}

bw_bcg_plot(23)
```

```{r psd-plot, fig.cap="Signal-to-noise ratio was higher for the triaxial BCG (lower panel, 2.00) than the surge-only BCG (upper panel, 0.17). Each panel shows the power spectral density for the BCG. Based on previously observed blue whale heart rates, 4-8 bpm was considered signal (gray shading). The signal-to-noise ratio was calculated as the ratio of the area under the curve in the signal frequencies to the area under the rest of the curve, up to 60 bpm."}
labels <- bw_psd %>% 
  filter(between(freq_bpm, 7.99, 8.01)) %>% 
  group_by(metric) %>% 
  slice(1) %>% 
  ungroup() %>% 
  left_join(psd_s2n, by = "metric") %>% 
  mutate(s2n_text = sprintf("Signal:noise = %0.2f", s2n))
ggplot(bw_psd, aes(x = freq_bpm, y = spec)) +
  geom_area(data = filter(bw_psd, between(freq_bpm, 4, 8)), fill = "grey80") +
  geom_path() +
  geom_text(aes(label = s2n_text), labels, hjust = -0.1, vjust = -0.05) +
  labs(x = "Frequency (bpm)",
       y = "Power spectrum density") +
  facet_grid(rows = vars(metric),
             scales = "free_y") +
  theme_classic() +
  theme(strip.background = element_blank(),
        strip.text = element_blank())
```

```{r bradycardia-relax, fig.cap="Heart rates observed in the 3d BCG followed characteristic diving physiology patterns. Bradycardia is greatest at the start of the dive (~4-5 bpm), increasing towards the end (~8-9 bpm)."}
ggplot(bpm_data, aes(dive_norm, bcg_bpm)) +
  geom_point() +
  geom_line(data = bpm_pred, color = "blue", size = 1.5) +
  scale_x_continuous() +
  labs(x = "Dive time (normalized)",
       y = "Heartrate (bpm)") +
  expand_limits(y = 0) +
  theme_classic()
```

# References 

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

<div id="refs"></div>

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
